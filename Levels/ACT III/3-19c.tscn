[gd_scene load_steps=14 format=2]

[ext_resource path="res://Assets/Act V/5509862.jpg" type="Texture" id=1]
[ext_resource path="res://Assets/Act III/galaxy.png" type="Texture" id=2]
[ext_resource path="res://Scenes/Characters/Rex (bad).tscn" type="PackedScene" id=3]
[ext_resource path="res://Scenes/LevelCamera.tscn" type="PackedScene" id=4]
[ext_resource path="res://Levels/CutscenePlayer.tscn" type="PackedScene" id=5]
[ext_resource path="res://Scripts/Cutscene.gd" type="Script" id=6]
[ext_resource path="res://Scenes/UI/GUI.tscn" type="PackedScene" id=7]
[ext_resource path="res://Scenes/Effects/SpeechBubble.tscn" type="PackedScene" id=8]

[sub_resource type="Animation" id=1]
resource_name = "cutscene"
length = 20.0
step = 0.01
tracks/0/type = "value"
tracks/0/path = NodePath("../Enemies/Rex (bad):mode")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 7.1 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ 0 ]
}
tracks/1/type = "method"
tracks/1/path = NodePath("../Enemies/Rex (bad)/SpeechBubble")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"times": PoolRealArray( 0.57 ),
"transitions": PoolRealArray( 1 ),
"values": [ {
"args": [  ],
"method": "start"
} ]
}

[sub_resource type="Shader" id=2]
code = "// Fire shader

shader_type canvas_item;

uniform vec2 fireMovement = vec2(-0.01, -0.5);
uniform vec2 distortionMovement = vec2(-0.01, -0.3);
uniform float normalStrength = 40.0;
uniform float distortionStrength=0.1;


/** NOISE **/
float rand(vec2 co) {
  return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}

vec2 hash( vec2 p ) {
	p = vec2( dot(p,vec2(127.1,311.7)),
			  dot(p,vec2(269.5,183.3)) );

	return -1.0 + 2.0*fract(sin(p)*43758.5453123);
}

float noise( in vec2 p ) {
   float K1 = 0.366025404; // (sqrt(3)-1)/2;
   float K2 = 0.211324865; // (3-sqrt(3))/6;

	vec2 i = floor( p + (p.x+p.y)*K1 );
	
    vec2 a = p - i + (i.x+i.y)*K2;
    vec2 o = step(a.yx,a.xy);    
    vec2 b = a - o + K2;
	vec2 c = a - 1.0 + 2.0*K2;

    vec3 h = max( 0.5-vec3(dot(a,a), dot(b,b), dot(c,c) ), 0.0 );

	vec3 n = h*h*h*h*vec3( dot(a,hash(i+0.0)), dot(b,hash(i+o)), dot(c,hash(i+1.0)));

    return dot( n, vec3(70.0) );
}

float fbm ( in vec2 p ) {
    float f = 0.0;
    mat2 m = mat2(vec2(1.6,  1.2), vec2(-1.2,  1.6 ));
    f  = 0.5000*noise(p); p = m*p;
    f += 0.2500*noise(p); p = m*p;
    f += 0.1250*noise(p); p = m*p;
    f += 0.0625*noise(p); p = m*p;
    f = 0.5 + 0.5 * f;
    return f;
}

/** DISTORTION **/
vec3 bumpMap(vec2 uv) { 
	vec2 iResolution = vec2(1024,600);
    vec2 s = 1. / iResolution.xy;
    float p =  fbm(uv);
    float h1 = fbm(uv + s * vec2(1., 0));
    float v1 = fbm(uv + s * vec2(0, 1.));
       
   	vec2 xy = (p - vec2(h1, v1)) * normalStrength;
    return vec3(xy + .5, 1.);
}

/** MAIN **/
void fragment() {
	float timeScale = TIME * 1.0;
	vec2 iResolution = vec2(1024,600);
    vec2 uv = FRAGCOORD.xy/iResolution.xy;

    vec3 normal = bumpMap(uv * vec2(1.0, 0.3) + distortionMovement * timeScale);
    
    vec2 displacement = clamp((normal.xy - .5) * distortionStrength, -1., 1.);
    uv += displacement; 
    
    vec2 uvT = (uv * vec2(1.0, 0.5)) + timeScale * fireMovement;
    float n = pow(fbm(8.0 * uvT), 1.0);    
    
    float gradient = pow(1.0 - uv.y, 2.0) * 5.;
    float finalNoise = n * gradient;
    
    vec3 color = finalNoise * vec3(2.*n, 2.*n*n*n, n*n*n*n);
    COLOR = vec4(color, 1.);
}"

[sub_resource type="ShaderMaterial" id=3]
shader = SubResource( 2 )
shader_param/fireMovement = Vector2( -0.01, -0.4 )
shader_param/distortionMovement = Vector2( -0.01, -0.3 )
shader_param/normalStrength = 40.0
shader_param/distortionStrength = 0.1

[sub_resource type="PhysicsMaterial" id=5]
rough = true
bounce = 0.06

[sub_resource type="CapsuleShape2D" id=6]
radius = 111.165
height = 324.301

[node name="3-19c" type="Node2D"]
script = ExtResource( 6 )

[node name="GUI" parent="." instance=ExtResource( 7 )]
text = "Now that the gang is out of the way, Rex takes over the entire universe. Still, Rex is unsatisfied. He craves more power. “They say that history repeats itself. That is why I will carve my own path. I will become more powerful than any being ever has been. I will become unstoppable. I do this to ensure justice for my people.” Rex sets course in his space station into the unknown regions of the universe."

[node name="VScrollBar2" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="0"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="VScrollBar3" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="1"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="VScrollBar4" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="2"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="VScrollBar5" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="3"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="VScrollBar6" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="4"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="VScrollBar7" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="5"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="VScrollBar8" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="6"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="VScrollBar9" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="7"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="VScrollBar10" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="8"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="VScrollBar11" type="VScrollBar" parent="GUI/EndOfLevel/Popup/WinLose" index="9"]
visible = false
anchor_right = 1.0
anchor_bottom = 1.0
step = 1.0

[node name="Label" parent="GUI/StoryText/VBoxContainer" index="0"]
margin_top = 0.0
margin_bottom = 1610.0

[node name="Control" parent="GUI/StoryText/VBoxContainer" index="1"]
margin_top = 1614.0
margin_bottom = 1614.0

[node name="CutscenePlayer" parent="GUI" instance=ExtResource( 5 )]
anims/cutscene = SubResource( 1 )

[node name="Background" type="Sprite" parent="."]
modulate = Color( 0.345098, 0.0588235, 0.0588235, 1 )
material = SubResource( 3 )
position = Vector2( 1130, 17 )
scale = Vector2( 1.30169, 1.10427 )
z_index = -99
texture = ExtResource( 1 )
region_rect = Rect2( 0, 0, 4000, 2000 )

[node name="LevelCamera" parent="." instance=ExtResource( 4 )]
position = Vector2( 374, -263 )
anchor_mode = 0
zoom = Vector2( 1.25, 1.25 )
editor_draw_limits = true

[node name="Props" type="Node2D" parent="."]
position = Vector2( 0, 80 )

[node name="Galaxy" type="Sprite" parent="Props"]
position = Vector2( 1026, 288 )
rotation = -0.00872665
scale = Vector2( 0.5, 0.5 )
texture = ExtResource( 2 )

[node name="StaticBody2D" type="StaticBody2D" parent="Props/Galaxy"]
position = Vector2( -22.6973, 79.805 )
physics_material_override = SubResource( 5 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="Props/Galaxy/StaticBody2D"]
position = Vector2( 55.0974, -125.524 )
rotation = -1.05513
shape = SubResource( 6 )

[node name="Enemies" type="Node2D" parent="."]

[node name="Rex (bad)" parent="Enemies" instance=ExtResource( 3 )]
position = Vector2( 1034, 205 )
mode = 1

[node name="SpeechBubble" parent="Enemies/Rex (bad)" instance=ExtResource( 8 )]
position = Vector2( -2, 17 )
scale = Vector2( 2, 2 )
dialogue = "MWAHAHAHAH"

[node name="Label" parent="Enemies/Rex (bad)/SpeechBubble/VBoxContainer" index="0"]
text = "MWAHAHAH"

[editable path="GUI"]
[editable path="GUI/StoryText"]
[editable path="Enemies/Rex (bad)/SpeechBubble"]
